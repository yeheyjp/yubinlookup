<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Postal Code Lookup</title>

  <!-- Load Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Load PapaParse library for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5BevivHCvehmNDuneqR1yNzLuGnSpIfOqT_dH9StuZEqShhkbSMzswdqLLwk-dJR6BBB-TO3S-hk2/pub?output=csv';

    let postalData = [];
    let cityTownData = {};

    function loadCSVData() {
      console.log("Loading CSV data from: ", csvUrl);
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(results) {
          postalData = results.data;
          console.log("CSV Data Loaded:", postalData);
          buildCityTownData();
        },
        error: function(error) {
          console.error("Error loading CSV data:", error);
        }
      });
    }

    function buildCityTownData() {
      postalData.forEach(row => {
        if (row.prefecture) {
          if (!cityTownData[row.prefecture]) {
            cityTownData[row.prefecture] = {};
          }
          if (row.city) {
            if (!cityTownData[row.prefecture][row.city]) {
              cityTownData[row.prefecture][row.city] = [];
            }
            if (row.town && !cityTownData[row.prefecture][row.city].includes(row.town)) {
              cityTownData[row.prefecture][row.city].push(row.town);
            }
          }
        }
      });
      loadPrefectures();
    }

    function loadPrefectures() {
      const prefectureSelect = document.getElementById('prefecture_select');
      prefectureSelect.innerHTML = '<option value="">Select Prefecture</option>';

      Object.keys(cityTownData).forEach(prefecture => {
        const option = document.createElement('option');
        option.value = prefecture;
        option.textContent = prefecture;
        prefectureSelect.appendChild(option);
      });
    }

    function loadCities() {
      const prefecture = document.getElementById('prefecture_select').value;
      const citySelect = document.getElementById('city_select');
      citySelect.innerHTML = '<option value="">Select City</option>';

      if (prefecture && cityTownData[prefecture]) {
        Object.keys(cityTownData[prefecture]).forEach(city => {
          const option = document.createElement('option');
          option.value = city;
          option.textContent = city;
          citySelect.appendChild(option);
        });
      }
    }

    function loadTowns() {
      const prefecture = document.getElementById('prefecture_select').value;
      const city = document.getElementById('city_select').value;
      const townSelect = document.getElementById('town_select');
      townSelect.innerHTML = '<option value="">Select Town</option>';

      if (prefecture && city && cityTownData[prefecture] && cityTownData[prefecture][city]) {
        cityTownData[prefecture][city].forEach(town => {
          const option = document.createElement('option');
          option.value = town;
          option.textContent = town;
          townSelect.appendChild(option);
        });
      }
    }

    function searchByPostalCode() {
      let postalCode = document.getElementById('postal_code_input').value.replace(/-/g, '');
      if (!postalCode) {
        alert("Please enter a postal code.");
        return;
      }
	  
	  // Clear manual search fields
	document.getElementById('prefecture_select').value = '';
	document.getElementById('city_select').innerHTML = '<option value="">Select City</option>';
	document.getElementById('town_select').innerHTML = '<option value="">Select Town</option>';

      const entries = postalData.filter(row => row.postal_code == postalCode);

      if (entries.length > 0) {
        const resultsContainer = document.getElementById("address_result");
        resultsContainer.innerHTML = '';

        entries.forEach(entry => {
          const englishAddress = `${entry.postal_code} ${entry.prefecture} ${entry.city} ${entry.town}`;
          const japaneseAddress = `${entry.postal_code} ${entry.prefecture_kanji} ${entry.city_kanji} ${entry.town_kanji}`;

          const resultGroup = document.createElement('div');
          resultGroup.classList.add('result-group', 'mb-4');

          resultGroup.innerHTML = `
            <p><strong>English Address:</strong> ${entry.english_address}</p>
            <p><strong>Japanese Address:</strong> ${entry.japanese_address}</p>
            <p><strong>Shipping Fee:</strong> ${entry.shipping_fee || 'N/A'}</p>
            <p><strong>Lead Time:</strong> ${entry.lead_time || 'N/A'}</p>
            <button class="btn btn-info" onclick="copyBoth(this)">Copy Both</button>
          `;

          resultsContainer.appendChild(resultGroup);
        });
      } else {
        document.getElementById("address_result").innerHTML = "<p>No data found for this postal code.</p>";
      }
    }

    function searchByLocation() {
      const prefecture = document.getElementById('prefecture_select').value;
      const city = document.getElementById('city_select').value;
      const town = document.getElementById('town_select').value;

      if (!prefecture || !city || !town) {
        alert("Please select a prefecture, city, and town.");
        return;
      }
	  
	  document.getElementById('postal_code_input').value = '';

      const entries = postalData.filter(row => {
        return row.prefecture === prefecture && row.city === city && row.town === town;
      });

      const resultsContainer = document.getElementById("address_result");
      resultsContainer.innerHTML = '';

      if (entries.length > 0) {
        entries.forEach(entry => {
          const englishAddress = `${entry.postal_code} ${entry.prefecture} ${entry.city} ${entry.town}`;
          const japaneseAddress = `${entry.postal_code} ${entry.prefecture_kanji} ${entry.city_kanji} ${entry.town_kanji}`;
          
          const resultGroup = document.createElement('div');
          resultGroup.classList.add('result-group', 'mb-4');
          resultGroup.innerHTML = `
            <p><strong>English Address:</strong> ${entry.english_address}</p>
            <p><strong>Japanese Address:</strong> ${entry.japanese_address}</p>
            <p><strong>Shipping Fee:</strong> ${entry.shipping_fee || 'N/A'}</p>
            <p><strong>Lead Time:</strong> ${entry.lead_time || 'N/A'}</p>
            <button class="btn btn-info" onclick="copyBoth(this)">Copy Both</button>
          `;
          resultsContainer.appendChild(resultGroup);
        });
      } else {
        resultsContainer.innerHTML = "<p>No data found for this location.</p>";
      }
    }

    function copyBoth(button) {
      const resultGroup = button.closest('.result-group');
      const englishAddress = resultGroup.querySelector("p:nth-child(1)").textContent.split(':')[1].trim();
      const japaneseAddress = resultGroup.querySelector("p:nth-child(2)").textContent.split(':')[1].trim();
      const textToCopy = `${englishAddress}\n${japaneseAddress}`;
      
      const tempTextArea = document.createElement('textarea');
      tempTextArea.value = textToCopy;
      document.body.appendChild(tempTextArea);
      tempTextArea.select();
      document.execCommand('copy');
      document.body.removeChild(tempTextArea);

      alert('Addresses copied to clipboard!');
    }

    window.onload = loadCSVData;
  </script>
</head>

<body>
  <div class="container mt-1">
    <h2 class="text-center mb-4">Yubin Lookup</h2>
    
    <!-- Postal code input group with search button on the right -->
    <div class="mb-4">
      <div class="input-group">
        <input type="text" id="postal_code_input" class="form-control" placeholder="Enter postal code">
        <button class="btn btn-primary" onclick="searchByPostalCode()">Search by Postal Code</button>
      </div>
    </div>

    <!-- Prefecture and City selectors in one row -->
    <div class="mb-4">
        <select id="prefecture_select" class="form-select" onchange="loadCities()">
          <option value="">Select Prefecture</option>
        </select>
	</div>
	<div class="mb-4">
        <select id="city_select" class="form-select" onchange="loadTowns()">
          <option value="">Select City</option>
        </select>
    </div>

    <!-- Town and Search by Location in another row -->
    <div class="mb-4">
        <select id="town_select" class="form-select">
          <option value="">Select Town</option>
        </select>
    </div>
    <div class="mb-4">
        <button class="btn btn-success w-100" onclick="searchByLocation()">Search by Location</button>
      </div>
    </div>

    <!-- Result display -->
    <div id="address_result" class="mt-4 text-center"></div>

    <!-- Copy Address Button -->
    <div id="copy_address_btn" class="text-center mt-4" style="display: none;">
      <button class="btn btn-info" onclick="copyAddress()">Copy Both</button>
    </div>
  </div>

  <!-- Load Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>


</html>
